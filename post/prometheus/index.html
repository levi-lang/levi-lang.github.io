<!DOCTYPE html>
<html lang="en-us">
    <head>
        

        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>kubesphere 监控: prometheus</title>
        
        <style>

    html body {
        font-family: 'Raleway', sans-serif;
        background-color: white;
    }

    :root {
        --accent: red;
        --border-width:  5px ;
    }

</style>


<link rel="stylesheet" href="https://levi-lang.github.io/css/main.css">





<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Raleway">


 <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css"> 


<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css" crossorigin="anonymous">


<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css" integrity="sha512-+4zCK9k+qNFUR5X+cKL9EIR+ZOhtIloNl9GIKS57V1MyNsYpYcUrUeQc9vNfzsWfV28IaLL3i96P9sdNyeRssA==" crossorigin="anonymous" />
 

    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
    
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/go.min.js"></script>
    
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/haskell.min.js"></script>
    
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/kotlin.min.js"></script>
    
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/scala.min.js"></script>
    
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/swift.min.js"></script>
    
    <script>hljs.initHighlightingOnLoad();</script>






<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>


<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>


<script>$(document).on('click', function() { $('.collapse').collapse('hide'); })</script>
 <meta name="generator" content="Hugo 0.101.0" />
        

        

        
            <script type="text/javascript" async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
        

        

    </head>

    <body>
        

        <nav class="navbar navbar-default navbar-fixed-top">
            <div class="container">
                <div class="navbar-header">
                    <a class="navbar-brand visible-xs" href="#">kubesphere 监控: prometheus</a>
                    <button class="navbar-toggle" data-target=".navbar-collapse" data-toggle="collapse">
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                </div>
                <div class="collapse navbar-collapse">
                    
                        <ul class="nav navbar-nav">
                            
                                <li><a href="/">Home</a></li>
                            
                                <li><a href="/about/">About</a></li>
                            
                                <li><a href="/post/">Posts</a></li>
                            
                                <li><a href="/project/">Projects</a></li>
                            
                        </ul>
                    
                    
                        <ul class="nav navbar-nav navbar-right">
                            
                                <li class="navbar-icon"><a href="mailto:me@example.com"><i class="fas fa-envelope"></i></a></li>
                            
                                <li class="navbar-icon"><a href="https://github.com/username/"><i class="fab fa-github"></i></a></li>
                            
                                <li class="navbar-icon"><a href="https://twitter.com/username/"><i class="fab fa-twitter"></i></a></li>
                            
                                <li class="navbar-icon"><a href="https://www.linkedin.com/in/username/"><i class="fab fa-linkedin"></i></a></li>
                            
                                <li class="navbar-icon"><a href="https://www.stackoverflow.com/username/"><i class="fab fa-stack-overflow"></i></a></li>
                            
                        </ul>
                    
                </div>
            </div>
        </nav>


<main>

    <div>
        <h2>kubesphere 监控: prometheus</h2>
        <h5>July 18, 2022</h5>
        

    </div>

    <div align="start" class="content"><h1 id="kubesphere-监控">kubesphere 监控</h1>
<pre tabindex="0"><code>kubesphere监控系统
安装好kubesphere就生成

kubesphere 事件系统
需要在kubesphere中开启

kubesphere 告警系统
需要在kubesphere中开启

kubesphere 审计日志
需要在kubesphere中开启

HPA 同样需要在kubesphere中开启


Prometheus 的告警分为两部分。
Prometheus 服务器根据告警规则向 Alertmanager 发送告警
从 3.0 版本开始，KubeSphere 向 Prometheus 添加了开源社区中流行的告警规则，用作内置告警规则。
默认情况下，KubeSphere 3.3.0 中的 Prometheus 会持续评估这些内置告警规则，然后向 Alertmanager 发送告警

Alertmanager 可用于管理 Prometheus 以外来源发出的告警。
在 3.0 版及更高版本的 KubeSphere 中
用户可以用它管理由 Kubernetes 事件触发的告警。
所以告警涉及到事件系统

在 3.0 版及更高版本的 KubeSphere 中
用户还可以使用 Alertmanager 管理由 Kubernetes 或 KubeSphere 审计事件触发的告警
所以告警设计到审计日志

一般来说，要接收 Alertmanager 告警的通知
用户需要手动编辑 Alertmanager 的配置文件，配置接收器（例如电子邮件和 Slack）的设置。
这对 Kubernetes 用户来说并不方便，并且违背了 KubeSphere 的多租户规则/架构。
具体来说，由不同命名空间中的工作负载所触发的告警可能会发送至同一个租户，然而这些告警信息本应发给不同的租户。

为了使用 Alertmanager 管理平台上的告警
KubeSphere 提供了 Notification Manager
它是一个 Kubernetes 原生通知管理工具，完全开源。
它符合多租户规则，提供用户友好的 Kubernetes 通知体验
3.0 版及更高版本的 KubeSphere 均默认安装 Notification Manager。

# 使用命令查看
kubectl get pods -n kubesphere-monitoring-system
# 告警
alertmanager-main-0                                2/2
alertmanager-main-1                                2/2
alertmanager-main-2                                2/2

# 扩容
kube-state-metrics-7bdc7484cf-67ds8                3/3

# 采集
node-exporter-d99nj                                2/2
node-exporter-mhrsw                                2/2
node-exporter-npswk                                2/2
node-exporter-rppd4                                2/2
node-exporter-s5zxl                                2/2
node-exporter-sgfwx                                2/2
node-exporter-sphdt                                2/2
node-exporter-v65fq                                2/2
node-exporter-vr4wb                                2/2

# 告警管理
notification-manager-deployment-78664576cb-qbvvc   2/2
notification-manager-deployment-78664576cb-x4hzv   2/2
notification-manager-operator-7d44854f54-bnh47     2/2

# 监控核心
prometheus-k8s-0                                   2/2
prometheus-k8s-1                                   2/2

# operator
prometheus-operator-8955bbd98-8tdps                2/2

# thanos高可用
thanos-ruler-kubesphere-0                          2/2
thanos-ruler-kubesphere-1                          2/2
</code></pre><h1 id="告警流程">告警流程</h1>
<p><img src="https://kubesphere.com.cn/images/docs/v3.3/cluster-administration/cluster-wide-alerting-and-notification/alertmanager-in-kubesphere/alertmanager@kubesphere.png" alt="avatar"></p>
<h1 id="通知管理">通知管理</h1>
<pre tabindex="0"><code>平台管理---平台设置---通知管理---通知配置
目前有五种通知形式
具体参照官网进行配置
webhokk、邮件、钉钉、企业微信、slack
</code></pre><h1 id="问题记录">问题记录</h1>
<h4 id="kubesphere-内置规则告警-cputhrottlinghigh">Kubesphere 内置规则告警: CPUThrottlingHigh</h4>
<pre tabindex="0"><code>kubectl edit PrometheusRule prometheus-k8s-rules -n kubesphere-monitoring-system

- alert: CPUThrottlingHigh      
  annotations:         
    description: &#39;{{ $value | humanizePercentage }} throttling of CPU in namespace          {{ $labels.namespace }} for container {{ $labels.container }} in pod {{ $labels.pod }}.&#39; 
    runbook_url: https://runbooks.prometheus-operator.dev/runbooks/kubernetes/cputhrottlinghigh        
    summary: Processes experience elevated CPU throttling.      
  expr: |        
    sum(increase(container_cpu_cfs_throttled_periods_total{container!=&#34;&#34;, }[5m])) by (container, pod, namespace) / sum(increase(container_cpu_cfs_periods_total{}[5m])) by (container, pod, namespace) &gt; ( 75 / 100 )

此处75 的值是修改过后的
原来的值是25
</code></pre></div>

    
    
    

    
    
        <h4 class="page-header">Comments</h4>
        <div id="disqus_thread"></div>
<script type="application/javascript">
    window.disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "username" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    

</main>

        <footer>
            <p class="copyright text-muted">© All rights reserved. Powered by <a href="https://gohugo.io">Hugo</a> and <a href="https://github.com/calintat/minimal">Minimal</a>.</p>
        </footer>

        

        
    </body>

</html>

